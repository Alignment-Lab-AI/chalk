networks:
  chalk:

services:
  chalk:
    build:
      context: .
      args:
        CHALK_BUILD: ${CHALK_BUILD:-debug}
    working_dir: $PWD
    volumes:
      - $PWD:$PWD

  chalk-compile:
    build:
      context: .
      target: compile
    command: sh -c "nimble debug"
    working_dir: $PWD
    volumes:
      - $PWD:$PWD

  chalk-config-compile:
    build:
      context: .
      dockerfile: docker/Dockerfile.chalk-config
      target: config-tool-compile
    command: sh -c "python chalk-config/chalkconf.py"
    volumes:
      - $PWD/config-tool:/config-tool
      - $PWD/.config-tool-bin:/config-bin
    environment:
      TERM: "xterm-256color"
      COLORTERM: "truecolor"
      CHALK_BINARIES_ARE_LOCAL: 1
    depends_on:
      - chalk-compile

  chalk-config:
    build:
      context: .
      dockerfile: docker/Dockerfile.chalk-config
    environment:
      TERM: "xterm-256color"
      COLORTERM: "truecolor"
      CHALK_BINARIES_ARE_LOCAL: 1
    volumes:
      - $PWD/.config-tool-bin:/config-bin
      - $PWD/config-tool-outdir:/outdir/

  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    command: >
      sh -c "if [ ! -f \"$PWD/server/app/data/chalk-selfsigned-private.key\" ] || [ ! -f \"/Users/rich.smith/Repositories/CrashOverride/chalk-internal/server/app/data/chalk-selfsigned-certificate.crt\" ];then python $PWD/server/app/main.py generate_certificate ${CHALK_SERVER_CERT_GEN_DOMAIN};fi &&
             gunicorn -b :8585 --workers=4 --preload --error-logfile=- --access-logfile=- --timeout 30 --keyfile $PWD/server/app/data/chalk-selfsigned-private.key --certfile=$PWD/server/app/data/chalk-selfsigned-certificate.crt -k uvicorn.workers.UvicornH11Worker main:app --reload"
    networks:
      chalk:
        aliases:
          - tests.crashoverride.run
    ports:
      - 8585:8585
    volumes:
      - $PWD:$PWD
    working_dir: $PWD/server/app

  sqlitebrowser:
    image: lscr.io/linuxserver/sqlitebrowser:latest
    container_name: sqlitebrowser
    security_opt:
      - seccomp:unconfined #optional
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - $PWD/server/app/data:/config
    ports:
      - 3000:3000
      - 3001:3001
    restart: unless-stopped

  tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.pytests
    command: pytest
    volumes:
      - $PWD:$PWD
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOME}/.aws:/root/.aws
    working_dir: $PWD
    networks:
      chalk:
    environment:
      AWS_PROFILE: ${AWS_PROFILE:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
