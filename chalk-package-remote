#!/usr/bin/expect

set oss "https://github.com/crashappsec/chalk.git"
set releasedir "/home/viega/release"
set blackstone_conf "/home/viega/chalk-internal/customers/blackstone-2023-05-04.conf"
set username "viega"

set nimbledir "/home/viega/.nimble/pkgs2"
set con4mjunk "$nimbledir/con4m* $nimbledir/../bin/con4m"
set nimutiljunk "$nimbledir/nimutils*"
set timeout 120

spawn ssh triforce
expect "$ "
send -- "rm -rf $con4mjunk\r"
expect "$ "
send -- "rm -rf $nimutiljunk\r"
expect "$ "
send -- "git clone $oss\r"
expect ": "
send -- "$username\r"
expect ": "
send -- "$env(GIT_SECRET)\r"
expect "$ "
send "cd chalk\r"
expect "$ "
send "nimble build\r"
expect "viega@triforce"
send -- "./chalk load $blackstone_conf\r"
expect "viega@triforce"
send -- "mv chalk.new $releasedir/chalk-debug-blackstone\r"
expect "$ "
send -- "mv chalk $releasedir/chalk-debug-amd64\r"
expect "$ "
# Now do it all again with a release build.
send "nimble build -d:release\r"
expect "viega@triforce"
send -- "strip chalk\r"
expect "$ "
send -- "./chalk load $blackstone_conf\r"
expect "viega@triforce"
send -- "mv chalk.new $releasedir/chalk-release-blackstone\r"
expect "$ "
send -- "mv chalk $releasedir/chalk-release-amd64\r"
expect "$ "
send "cd ..\r"
expect "$ "
send "rm -rf chalk/\r"
expect "$ "
send "exit\r"
