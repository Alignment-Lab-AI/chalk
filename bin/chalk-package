#!/bin/sh

export oss="https://github.com/crashappsec/chalk.git"
export workdir="/Users/viega/dev"
export releasedir="/Users/viega/dev/release"
export remotedir="/home/viega/release"
export nimbledir="/Users/viega/.nimble/pkgs2"
export con4mjunk="$nimbledir/con4m* $nimbledir/../bin/con4m"
export nimutiljunk="$nimbledir/nimutils*"

rm -rf $con4mjunk
rm -rf $nimutiljunk

cd $workdir
git clone $oss
cd chalk
export VERSION=`egrep "version[ ]+\=" chalk.nimble | grep -po '".*"' | egrep -po '[^"]+'`
echo "Running build on MacOS"
nimble build
mv chalk $releasedir/chalk-${VERSION}-debug-macos-arm
nimble build -d:release
mv chalk $releasedir/chalk-${VERSION}-release-macos-arm
cd ..
rm -rf /Users/viega/dev/chalk
echo "Logging into our Linux host"
$(dirname -- "${BASH_SOURCE[0]}")/chalk-package-remote
cd $releasedir
scp triforce:$remotedir/chalk-debug-amd64    $releasedir/chalk-${VERSION}-debug-amd64
scp triforce:$remotedir/chalk-release-amd64  $releasedir/chalk-${VERSION}-release-amd64
scp triforce:$remotedir/chalk-debug-blackstone $releasedir/chalk-${VERSION}-debug-blackstone
scp triforce:$remotedir/chalk-release-blackstone $releasedir/chalk-${VERSION}-release-blackstone
#ssh triforce rm $remotedir/chalk-debug-amd64 $remotedir/chalk-release-amd64 $remotedir/chalk-debug-blackstone $remotedir/chalk-release-blackstone
